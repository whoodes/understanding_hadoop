<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="4161px" height="2320px" viewBox="-0.5 -0.5 4161 2320" content="&lt;mxfile modified=&quot;2019-06-27T02:04:23.059Z&quot; host=&quot;www.draw.io&quot; agent=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36&quot; version=&quot;10.8.1&quot; etag=&quot;MN3S1opMchdXiY5KM3a3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;n73HqSdXbu6ViPsut5pn&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;"><defs/><g><rect x="0" y="9" width="730" height="1230" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(5.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="713" height="1238" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 1238px; max-width: 718px; width: 714px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>ReduceTask.java</h1><pre>@Override<br />@SuppressWarnings(<span>"unchecked"</span>)<br /><span>public void </span>run(JobConf job<span>, final </span>TaskUmbilicalProtocol umbilical)<br /><span>throws </span>IOException<span>, </span>InterruptedException<span>, </span>ClassNotFoundException {<br />  job.setBoolean(JobContext.SKIP_RECORDS<span>, </span>isSkipping())<span>;<br /></span><span><br /></span><span>  if </span>(isMapOrReduce()) {<br />    copyPhase = getProgress().addPhase(<span>"copy"</span>)<span>;<br /></span>    sortPhase  = getProgress().addPhase(<span>"sort"</span>)<span>;<br /></span>    reducePhase = getProgress().addPhase(<span>"reduce"</span>)<span>;<br /></span>  }</pre><pre><br /><span>  // start thread that will handle communication with parent<br /></span>  TaskReporter reporter = startReporter(umbilical)<span>;<br /></span><span><br /></span><span>  boolean </span>useNewApi = job.getUseNewReducer()<span>;<br /></span>  initialize(job<span>, </span>getJobID()<span>, </span>reporter<span>, </span>useNewApi)<span>;<br /></span><span><br /></span><span>  // check if it is a cleanupJobTask<br /></span><span>  if </span>(jobCleanup) {<br />    runJobCleanupTask(umbilical<span>, </span>reporter)<span>;<br /></span><span>    return;<br /></span>  }<br /><span>  if </span>(jobSetup) {<br />    runJobSetupTask(umbilical<span>, </span>reporter)<span>;<br /></span><span>    return;<br /></span>  }<br /><span>  if </span>(taskCleanup) {<br />    runTaskCleanupTask(umbilical<span>, </span>reporter)<span>;<br /></span><span>    return;<br /></span>  }<br /><br /><span>  // Initialize the codec<br /></span>  codec = initCodec()<span>;<br /></span>  RawKeyValueIterator rIter = <span>null;<br /></span>  ShuffleConsumerPlugin shuffleConsumerPlugin = <span>null;<br /></span><span><br /></span>  Class combinerClass = conf.getCombinerClass()<span>;<br /></span>  CombineOutputCollector combineCollector = <br />    (<span>null </span>!= combinerClass) ? <br /><span>    new </span>CombineOutputCollector(reduceCombineOutputCounter<span>, </span>reporter<span>, </span>conf) : <span>null;<br /></span><span><br /></span>  Class&lt;? <span>extends </span>ShuffleConsumerPlugin&gt; clazz =<br />        job.getClass(MRConfig.SHUFFLE_CONSUMER_PLUGIN<span>, </span>Shuffle.<span>class, </span>ShuffleConsumerPlugin.<span>class</span>)<span>;<br /></span><span><br /></span>  shuffleConsumerPlugin = ReflectionUtils.newInstance(clazz<span>, </span>job)<span>;<br /></span>  LOG.info(<span>"Using ShuffleConsumerPlugin: " </span>+ shuffleConsumerPlugin)<span>;<br /></span><span><br /></span>  ShuffleConsumerPlugin.Context shuffleContext = <br /><span>  new </span>ShuffleConsumerPlugin.Context(getTaskID()<span>, </span>job<span>, </span>FileSystem.getLocal(job)<span>, </span>umbilical<span>, <br /></span><span>                super</span>.lDirAlloc<span>, </span>reporter<span>, </span>codec<span>, <br /></span>                combinerClass<span>, </span>combineCollector<span>, <br /></span>                spilledRecordsCounter<span>, </span>reduceCombineInputCounter<span>,<br /></span>                shuffledMapsCounter<span>,<br /></span>                reduceShuffleBytes<span>, </span>failedShuffleCounter<span>,<br /></span>                mergedMapOutputsCounter<span>,<br /></span>                taskStatus<span>, </span>copyPhase<span>, </span>sortPhase<span>, this,<br /></span>                mapOutputFile<span>, </span>localMapFiles)<span>;<br /></span><b><font color="#000000">  shuffleConsumerPlugin.init(shuffleContext);<br /></font></b><span><br /></span><b>  rIter = shuffleConsumerPlugin.run()<span>;<br /></span></b><span><br /></span><span>  // free up the data structures<br /></span>  mapOutputFilesOnDisk.clear()<span>;<br /></span><span><br /></span>  sortPhase.complete()<span>;                         </span><span>// sort is complete<br /></span>  setPhase(TaskStatus.Phase.REDUCE)<span>; <br /></span>  statusUpdate(umbilical)<span>;<br /></span>  Class keyClass = job.getMapOutputKeyClass()<span>;<br /></span>  Class valueClass = job.getMapOutputValueClass()<span>;<br /></span>  RawComparator comparator = job.getOutputValueGroupingComparator()<span>;<br /></span><span><br /></span><span>  if </span>(useNewApi) {<br />    runNewReducer(job<span>, </span>umbilical<span>, </span>reporter<span>, </span>rIter<span>, </span>comparator<span>, <br /></span>    keyClass<span>, </span>valueClass)<span>;<br /></span>  } <span>else </span>{<br />    runOldReducer(job<span>, </span>umbilical<span>, </span>reporter<span>, </span>rIter<span>, </span>comparator<span>,  <br /></span>  keyClass<span>, </span>valueClass)<span>;<br /></span>  }<br /><br />  shuffleConsumerPlugin.close()<span>;<br /></span>  done(umbilical<span>, </span>reporter)<span>;</span><span><br /></span>}</pre></div></div></foreignObject><text x="357" y="625" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="790" y="9" width="560" height="370" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(795.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="540" height="350" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 378px; max-width: 548px; width: 541px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>Shuffle.java</h1><pre>@Override<br /><span>public void </span>init(ShuffleConsumerPlugin.Context context) {<br /><span>  this</span>.context = context<span>;<br /></span><span><br /></span><span>  this</span>.reduceId = context.getReduceId()<span>;<br /></span><span>  this</span>.jobConf = context.getJobConf()<span>;<br /></span><span>  this</span>.umbilical = context.getUmbilical()<span>;<br /></span><span>  this</span>.reporter = context.getReporter()<span>;<br /></span><span>  this</span>.metrics = ShuffleClientMetrics.create(context.getReduceId()<span>,<br /></span><span>      this</span>.jobConf)<span>;<br /></span><span>  this</span>.copyPhase = context.getCopyPhase()<span>;<br /></span><span>  this</span>.taskStatus = context.getStatus()<span>;<br /></span><span>  this</span>.reduceTask = context.getReduceTask()<span>;<br /></span><span>  this</span>.localMapFiles = context.getLocalMapFiles()<span>;<br /></span><span><br /></span>  scheduler = <span>new </span>ShuffleSchedulerImpl&lt;K<span>, </span>V&gt;(jobConf<span>, </span>taskStatus<span>, </span>reduceId<span>,<br /></span><span>      this, </span>copyPhase<span>, </span>context.getShuffledMapsCounter()<span>,<br /></span>      context.getReduceShuffleBytes()<span>, </span>context.getFailedShuffleCounter())<span>;<br /></span><b>  merger = createMergeManager(context)<span>;<br /></span></b>}</pre></div></div></foreignObject><text x="270" y="181" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 340 888 L 783.91 88.57" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 786.46 83.98 L 786.12 91.8 L 783.91 88.57 L 780 88.4 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 791 341 L 344 895.04" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 340.7 899.13 L 342.37 891.48 L 344 895.04 L 347.82 895.88 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><rect x="1480" y="9" width="560" height="220" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(1485.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="547" height="210" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 228px; max-width: 548px; width: 548px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>Shuffle.java</h1><pre><pre>protected MergeManager&lt;K, V&gt; createMergeManager(<br />    ShuffleConsumerPlugin.Context context) {<br />  return <b>new </b><b>MergeManagerImpl&lt;K<span>, </span>V&gt;(reduceId<span>, </span>jobConf<span>, </span>context.getLocalFS()<span>,<br /></span>    context.getLocalDirAllocator()<span>, </span>reporter<span>, </span>context.getCodec()<span>,<br /></span>    context.getCombinerClass()<span>, </span>context.getCombineCollector()<span>, <br /></span>    context.getSpilledRecordsCounter()<span>,<br /></span>    context.getReduceCombineInputCounter()<span>,<br /></span>    context.getMergedMapOutputsCounter()<span>, this, </span>context.getMergePhase()<span>,<br /></span>    context.getMapOutputFile())</b><b>;</b><br />}</pre></pre></div></div></foreignObject><text x="274" y="111" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 1080 319 L 1474.63 67.42" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 1479.06 64.6 L 1475.04 71.32 L 1474.63 67.42 L 1471.27 65.41 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 1478 202 L 1086.07 327.06" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 1081.07 328.66 L 1086.67 323.2 L 1086.07 327.06 L 1088.8 329.87 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><rect x="2110" y="9" width="620" height="1560" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(2115.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="562" height="1552" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 1568px; max-width: 608px; width: 563px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>MergeManagerImpl.java</h1><pre><pre><pre><span>public </span>MergeManagerImpl(TaskAttemptID reduceId<span>, </span>JobConf jobConf<span>, <br /></span>            FileSystem localFS<span>,<br /></span>            LocalDirAllocator localDirAllocator<span>,  <br /></span>            Reporter reporter<span>,<br /></span>            CompressionCodec codec<span>,<br /></span>            Class&lt;? <span>extends </span>Reducer&gt; combinerClass<span>,<br /></span>            CombineOutputCollector&lt;K<span>,</span>V&gt; combineCollector<span>,<br /></span>            Counters.Counter spilledRecordsCounter<span>,<br /></span>            Counters.Counter reduceCombineInputCounter<span>,<br /></span>            Counters.Counter mergedMapOutputsCounter<span>,<br /></span>            ExceptionReporter exceptionReporter<span>,<br /></span>            Progress mergePhase<span>, </span>MapOutputFile mapOutputFile) {<br /><span>  this</span>.reduceId = reduceId<span>;<br /></span><span>  this</span>.jobConf = jobConf<span>;<br /></span><span>  this</span>.localDirAllocator = localDirAllocator<span>;<br /></span><span>  this</span>.exceptionReporter = exceptionReporter<span>;<br /></span><span><br /></span><span>  this</span>.reporter = reporter<span>;<br /></span><span>  this</span>.codec = codec<span>;<br /></span><span>  this</span>.combinerClass = combinerClass<span>;<br /></span><span>  this</span>.combineCollector = combineCollector<span>;<br /></span><span>  this</span>.reduceCombineInputCounter = reduceCombineInputCounter<span>;<br /></span><span>  this</span>.spilledRecordsCounter = spilledRecordsCounter<span>;<br /></span><span>  this</span>.mergedMapOutputsCounter = mergedMapOutputsCounter<span>;<br /></span><span>  this</span>.mapOutputFile = mapOutputFile<span>;<br /></span><span>  this</span>.mapOutputFile.setConf(jobConf)<span>;<br /></span><span><br /></span><span>  this</span>.localFS = localFS<span>;<br /></span><span>  this</span>.rfs = ((LocalFileSystem)localFS).getRaw()<span>;<br /></span><span><br /></span><span>  final float </span>maxInMemCopyUse =<br />    jobConf.getFloat(MRJobConfig.SHUFFLE_INPUT_BUFFER_PERCENT<span>,<br /></span>      MRJobConfig.DEFAULT_SHUFFLE_INPUT_BUFFER_PERCENT)<span>;<br /></span><span>  if </span>(maxInMemCopyUse &gt; <span>1.0 </span>|| maxInMemCopyUse &lt; <span>0.0</span>) {<br /><span>    throw new </span>IllegalArgumentException(<span>"Invalid value for " </span>+<br />        MRJobConfig.SHUFFLE_INPUT_BUFFER_PERCENT + <span>": " </span>+<br />        maxInMemCopyUse)<span>;<br /></span>  }<br /><br /><span>  // Allow unit tests to fix Runtime memory<br /></span><span>  this</span>.memoryLimit = (<span>long</span>)(jobConf.getLong(<br />      MRJobConfig.REDUCE_MEMORY_TOTAL_BYTES<span>,<br /></span>      Runtime.getRuntime().maxMemory()) * maxInMemCopyUse)<span>;</span></pre><pre><span><br /></span><span>  this</span>.ioSortFactor = jobConf.getInt(MRJobConfig.IO_SORT_FACTOR<span>,<br /></span>    MRJobConfig.DEFAULT_IO_SORT_FACTOR)<span>;<br /></span><span><br /></span><span>  final float </span>singleShuffleMemoryLimitPercent =<br />      jobConf.getFloat(MRJobConfig.SHUFFLE_MEMORY_LIMIT_PERCENT<span>,<br /></span>      DEFAULT_SHUFFLE_MEMORY_LIMIT_PERCENT)<span>;<br /></span><span>  if </span>(singleShuffleMemoryLimitPercent &lt; <span>0.0f<br /></span>    || singleShuffleMemoryLimitPercent &gt; <span>1.0f</span>) {<br /><span>       throw new </span>IllegalArgumentException(<span>"Invalid value for "<br /></span>         + MRJobConfig.SHUFFLE_MEMORY_LIMIT_PERCENT + <span>": "<br /></span>         + singleShuffleMemoryLimitPercent)<span>;<br /></span>  }<br /><br />  usedMemory = <span>0L</span><span>;<br /></span>  commitMemory = <span>0L</span><span>;<br /></span><span>  long </span>maxSingleShuffleLimitConfiged =<br />      (<span>long</span>)(memoryLimit * singleShuffleMemoryLimitPercent)<span>;<br /></span><span>  if</span>(maxSingleShuffleLimitConfiged &gt; Integer.MAX_VALUE) {<br />    maxSingleShuffleLimitConfiged = Integer.MAX_VALUE<span>;<br /></span>    LOG.info(<span>"The max number of bytes for a single in-memory shuffle cannot" </span>+<br /><span>      " be larger than Integer.MAX_VALUE. Setting it to Integer.MAX_VALUE"</span>)<span>;<br /></span>  }<br /><span>  this</span>.maxSingleShuffleLimit = maxSingleShuffleLimitConfiged<span>;<br /></span><span>  this</span>.memToMemMergeOutputsThreshold =<br />      jobConf.getInt(MRJobConfig.REDUCE_MEMTOMEM_THRESHOLD<span>, </span>ioSortFactor)<span>;<br /></span><span>  this</span>.mergeThreshold = (<span>long</span>)(<span>this</span>.memoryLimit * <br />                        jobConf.getFloat(<br />                          MRJobConfig.SHUFFLE_MERGE_PERCENT<span>,<br /></span>                          MRJobConfig.DEFAULT_SHUFFLE_MERGE_PERCENT))<span>;<br /></span>  LOG.info(<span>"MergerManager: memoryLimit=" </span>+ memoryLimit + <span>", " </span>+<br /><span>           "maxSingleShuffleLimit=" </span>+ maxSingleShuffleLimit + <span>", " </span>+<br /><span>           "mergeThreshold=" </span>+ mergeThreshold + <span>", " </span>+ <br /><span>           "ioSortFactor=" </span>+ ioSortFactor + <span>", " </span>+<br /><span>           "memToMemMergeOutputsThreshold=" </span>+ memToMemMergeOutputsThreshold)<span>;<br /></span><span><br /></span><span>  if </span>(<span>this</span>.maxSingleShuffleLimit &gt;= <span>this</span>.mergeThreshold) {<br /><span>    throw new </span>RuntimeException(<span>"Invalid configuration: "<br /></span>      + <span>"maxSingleShuffleLimit should be less than mergeThreshold "<br /></span>      + <span>"maxSingleShuffleLimit: " </span>+ <span>this</span>.maxSingleShuffleLimit<br />      + <span>"mergeThreshold: " </span>+ <span>this</span>.mergeThreshold)<span>;<br /></span>  }<br /><br /><span>  boolean </span>allowMemToMemMerge = <br />    jobConf.getBoolean(MRJobConfig.REDUCE_MEMTOMEM_ENABLED<span>, false</span>)<span>;<br /></span><span>    if </span>(allowMemToMemMerge) {<br /><span>      this</span>.memToMemMerger = <br /><span>        new </span>IntermediateMemoryToMemoryMerger(<span>this,<br /></span>                                             memToMemMergeOutputsThreshold)<span>;<br /></span><span>      this</span>.memToMemMerger.start()<span>;<br /></span>  } <span>else </span>{<br /><span>    this</span>.memToMemMerger = <span>null;<br /></span>  }<br /><br /><span>  this</span>.inMemoryMerger = createInMemoryMerger()<span>;<br /></span><b><span>  this</span>.inMemoryMerger.start()<span>;<br /></span></b><span><br /></span><span>  this</span>.onDiskMerger = <span>new </span>OnDiskMerger(<span>this</span>)<span>;<br /></span><b><span>  this</span>.onDiskMerger.start()<span>;<br /></span></b><span><br /></span><span>  this</span>.mergePhase = mergePhase<span>;<br /></span>}</pre></pre></pre></div></div></foreignObject><text x="281" y="782" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 2040 94 L 2103.13 67.47" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2107.97 65.43 L 2102.87 71.37 L 2103.13 67.47 L 2100.16 64.92 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2109 1533 L 2040.32 180.36" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 2040.06 175.12 L 2043.91 181.93 L 2040.32 180.36 L 2036.92 182.29 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><rect x="2830" y="9" width="450" height="490" fill="#e1d5e7" stroke="#9673a6" pointer-events="none"/><g transform="translate(2835.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="374" height="490" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 498px; max-width: 438px; width: 375px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>MergeThread.java</h1><pre><pre><pre><pre><span>public void </span>run() {<br /><span>  while </span>(<span>true</span>) {<br />    List&lt;T&gt; inputs = <span>null;<br /></span><span>    try </span>{<br /><span>      // Wait for notification to start the merge...<br /></span><span>      synchronized </span>(pendingToBeMerged) {<br /><span>        while</span>(pendingToBeMerged.size() &lt;= <span>0</span>) {<br />          pendingToBeMerged.wait()<span>;<br /></span>        }<br /><span>        // Pickup the inputs to merge.<br /></span>        inputs = pendingToBeMerged.removeFirst()<span>;<br /></span>      }<br /><br /><span>      // Merge<br /></span>      <b>merge(inputs)<span>;<br /></span> </b>   } <span>catch </span>(InterruptedException ie) {<br />      numPending.set(<span>0</span>)<span>;<br /></span><span>      return;<br /></span>    } <span>catch</span>(Throwable t) {<br />      numPending.set(<span>0</span>)<span>;<br /></span>      reporter.reportException(t)<span>;<br /></span><span>      return;<br /></span>    } <span>finally </span>{<br /><span>      synchronized </span>(<span>this</span>) {<br />        numPending.decrementAndGet()<span>;<br /></span>        notifyAll()<span>;<br /></span>      }<br />    }<br />  }<br />}</pre></pre></pre></pre></div></div></foreignObject><text x="187" y="251" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 2330 1449 L 2825.84 73.99" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2827.62 69.05 L 2828.54 76.82 L 2825.84 73.99 L 2821.95 74.45 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2320 1489 L 2826.72 645.46" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2829.42 640.96 L 2828.82 648.76 L 2826.72 645.46 L 2822.82 645.16 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 2830 475 L 2332.92 1439.34" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 2330.51 1444.01 L 2330.61 1436.18 L 2332.92 1439.34 L 2336.83 1439.39 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 2830 1049 L 2324.82 1484.84" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 2320.85 1488.27 L 2323.86 1481.05 L 2324.82 1484.84 L 2328.43 1486.35 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><rect x="2830" y="579" width="450" height="490" fill="#e1d5e7" stroke="#9673a6" pointer-events="none"/><g transform="translate(2835.5,569.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="374" height="490" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 498px; max-width: 438px; width: 375px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>MergeThread.java</h1><pre><pre><pre><pre><span>public void </span>run() {<br /><span>  while </span>(<span>true</span>) {<br />    List&lt;T&gt; inputs = <span>null;<br /></span><span>    try </span>{<br /><span>      // Wait for notification to start the merge...<br /></span><span>      synchronized </span>(pendingToBeMerged) {<br /><span>        while</span>(pendingToBeMerged.size() &lt;= <span>0</span>) {<br />          pendingToBeMerged.wait()<span>;<br /></span>        }<br /><span>        // Pickup the inputs to merge.<br /></span>        inputs = pendingToBeMerged.removeFirst()<span>;<br /></span>      }<br /><br /><span>      // Merge<br /></span>      <b>merge(inputs)</b><span><b>;</b><br /></span>    } <span>catch </span>(InterruptedException ie) {<br />      numPending.set(<span>0</span>)<span>;<br /></span><span>      return;<br /></span>    } <span>catch</span>(Throwable t) {<br />      numPending.set(<span>0</span>)<span>;<br /></span>      reporter.reportException(t)<span>;<br /></span><span>      return;<br /></span>    } <span>finally </span>{<br /><span>      synchronized </span>(<span>this</span>) {<br />        numPending.decrementAndGet()<span>;<br /></span>        notifyAll()<span>;<br /></span>      }<br />    }<br />  }<br />}</pre></pre></pre></pre></div></div></foreignObject><text x="187" y="251" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="3500" y="9" width="660" height="1180" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(3505.5,-0.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="648" height="1188" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 1188px; max-width: 648px; width: 648px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>MergeManagerImpl.java</h1><pre><pre><pre><pre><span>private class </span>InMemoryMerger <span>extends </span>MergeThread&lt;InMemoryMapOutput&lt;K<span>,</span>V&gt;<span>, </span>K<span>,</span>V&gt; {<br /><br /><span>  public </span>InMemoryMerger(MergeManagerImpl&lt;K<span>, </span>V&gt; manager) {<br /><span>    super</span>(manager<span>, </span>Integer.MAX_VALUE<span>, </span>exceptionReporter)<span>;<br /></span>    setName<br />    (<span>"InMemoryMerger - Thread to merge in-memory shuffled map-outputs"</span>)<span>;<br /></span>    setDaemon(<span>true</span>)<span>;<br /></span>}<br /><br />  @Override<br /><span>  public void </span>merge(List&lt;InMemoryMapOutput&lt;K<span>,</span>V&gt;&gt; inputs) <span>throws </span>IOException {<br /><span>    if </span>(inputs == <span>null </span>|| inputs.size() == <span>0</span>) {<br /><span>      return;<br /></span>    }<br /><br /><span>    //name this output file same as the name of the first file that is <br /></span><span>    //there in the current list of inmem files (this is guaranteed to<br /></span><span>    //be absent on the disk currently. So we don't overwrite a prev. <br /></span><span>    //created spill). Also we need to create the output file now since<br /></span><span>    //it is not guaranteed that this file will be present after merge<br /></span><span>    //is called (we delete empty files as soon as we see them<br /></span><span>    //in the merge method)<br /></span><span><br /></span><span>    //figure out the mapId <br /></span>    TaskAttemptID mapId = inputs.get(<span>0</span>).getMapId()<span>;<br /></span>    TaskID mapTaskId = mapId.getTaskID()<span>;<br /></span><span><br /></span>    List&lt;Segment&lt;K<span>, </span>V&gt;&gt; inMemorySegments = <span>new </span>ArrayList&lt;Segment&lt;K<span>, </span>V&gt;&gt;()<span>;<br /></span><span>    long </span>mergeOutputSize = createInMemorySegments(inputs<span>, </span>inMemorySegments<span>,</span><span>0</span>)<span>;<br /></span><span>    int </span>noInMemorySegments = inMemorySegments.size()<span>;<br /></span><span><br /></span>    Path outputPath = mapOutputFile.getInputFileForWrite(mapTaskId<span>,<br /></span>                    mergeOutputSize).suffix(<br />                                     Task.MERGED_OUTPUT_PREFIX)<span>;<br /></span><span><br /></span>    FSDataOutputStream out = CryptoUtils.wrapIfNecessary(jobConf<span>, </span>rfs.create(outputPath))<span>;<br /></span>    Writer&lt;K<span>, </span>V&gt; writer = <span>new </span>Writer&lt;K<span>, </span>V&gt;(jobConf<span>, </span>out<span>,<br /></span>      (Class&lt;K&gt;) jobConf.getMapOutputKeyClass()<span>,<br /></span>      (Class&lt;V&gt;) jobConf.getMapOutputValueClass()<span>, </span>codec<span>, null, true</span>)<span>;<br /></span><span><br /></span>    RawKeyValueIterator rIter = <span>null;<br /></span>    CompressAwarePath compressAwarePath<span>;<br /></span><span>    try </span>{<br />      LOG.info(<span>"Initiating in-memory merge with " </span>+ noInMemorySegments + <br /><span>               " segments..."</span>)<span>;<br /></span><span><br /></span>      rIter = <b>Merger.merge(jobConf<span>, </span>rfs<span>,<br /></span>                          (Class&lt;K&gt;)jobConf.getMapOutputKeyClass()<span>,<br /></span>                          (Class&lt;V&gt;)jobConf.getMapOutputValueClass()<span>,<br /></span>                           inMemorySegments<span>, </span>inMemorySegments.size()<span>,<br /></span><span>                           new </span>Path(reduceId.toString())<span>,<br /></span>                          (RawComparator&lt;K&gt;)jobConf.getOutputKeyComparator()<span>,<br /></span>                           reporter<span>, </span>spilledRecordsCounter<span>, null, null</span>)</b><span><b>;</b><br /></span><span><br /></span><span>      if </span>(<span>null </span>== combinerClass) {<br />        Merger.writeFile(rIter<span>, </span>writer<span>, </span>reporter<span>, </span>jobConf)<span>;<br /></span>      } <span>else </span>{<br />        combineCollector.setWriter(writer)<span>;<br /></span>        combineAndSpill(rIter<span>, </span>reduceCombineInputCounter)<span>;<br /></span>      }<br />      writer.close()<span>;<br /></span>      compressAwarePath = <span>new </span>CompressAwarePath(outputPath<span>,<br /></span>      writer.getRawLength()<span>, </span>writer.getCompressedLength())<span>;<br /></span><span><br /></span>      LOG.info(reduceId +  <br /><span>               " Merge of the " </span>+ noInMemorySegments +<br /><span>               " files in-memory complete." </span>+<br /><span>               " Local file is " </span>+ outputPath + <span>" of size " </span>+ <br />               localFS.getFileStatus(outputPath).getLen())<span>;<br /></span>    } <span>catch </span>(IOException e) { <br /><span>      //make sure that we delete the ondisk file that we created <br /></span><span>      //earlier when we invoked cloneFileAttributes<br /></span>      localFS.delete(outputPath<span>, true</span>)<span>;<br /></span><span>      throw </span>e<span>;<br /></span>    }<br /><br /><span>    // Note the output of the merge<br /></span>    closeOnDiskFile(compressAwarePath)<span>;<br /></span>  }<br />}</pre></pre></pre></pre></div></div></foreignObject><text x="324" y="600" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 2980 259 L 3497 206" fill="none" stroke="#d6b656" stroke-width="3" stroke-miterlimit="10" stroke-dasharray="9 9" pointer-events="none"/><rect x="3500" y="1219" width="660" height="1100" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(3505.5,1209.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="648" height="1106" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 1108px; max-width: 648px; width: 648px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>MergeManagerImpl.java</h1><pre><pre><pre><pre><pre><span>private class </span>OnDiskMerger <span>extends </span>MergeThread&lt;CompressAwarePath<span>,</span>K<span>,</span>V&gt; {<br /><br /><span>  public </span>OnDiskMerger(MergeManagerImpl&lt;K<span>, </span>V&gt; manager) {<br /><span>    super</span>(manager<span>, </span>ioSortFactor<span>, </span>exceptionReporter)<span>;<br /></span>    setName(<span>"OnDiskMerger - Thread to merge on-disk map-outputs"</span>)<span>;<br /></span>    setDaemon(<span>true</span>)<span>;<br /></span>  }<br /><br />  @Override<br /><span>  public void </span>merge(List&lt;CompressAwarePath&gt; inputs) <span>throws </span>IOException {<br /><span>    // sanity check<br /></span><span>    if </span>(inputs == <span>null </span>|| inputs.isEmpty()) {<br />      LOG.info(<span>"No ondisk files to merge..."</span>)<span>;<br /></span><span>      return;<br /></span>    }<br /><br /><span>    long </span>approxOutputSize = <span>0</span><span>;<br /></span><span>    int </span>bytesPerSum = <br />      jobConf.getInt(<span>"io.bytes.per.checksum"</span><span>, </span><span>512</span>)<span>;<br /></span><span><br /></span>    LOG.info(<span>"OnDiskMerger: We have  " </span>+ inputs.size() + <br /><span>             " map outputs on disk. Triggering merge..."</span>)<span>;<br /></span><span><br /></span><span>    // 1. Prepare the list of files to be merged. <br /></span><span>    for </span>(CompressAwarePath file : inputs) {<br />      approxOutputSize += localFS.getFileStatus(file).getLen()<span>;<br /></span>    }<br /><br /><span>    // add the checksum length<br /></span>    approxOutputSize += <br />      ChecksumFileSystem.getChecksumLength(approxOutputSize<span>, </span>bytesPerSum)<span>;<br /></span><span><br /></span><span>    // 2. Start the on-disk merge process<br /></span>    Path outputPath = <br />      localDirAllocator.getLocalPathForWrite(inputs.get(<span>0</span>).toString()<span>, <br /></span>        approxOutputSize<span>, </span>jobConf).suffix(Task.MERGED_OUTPUT_PREFIX)<span>;<br /></span><span><br /></span>    FSDataOutputStream out = CryptoUtils.wrapIfNecessary(jobConf<span>, </span>rfs.create(outputPath))<span>;<br /></span>    Writer&lt;K<span>, </span>V&gt; writer = <span>new </span>Writer&lt;K<span>, </span>V&gt;(jobConf<span>, </span>out<span>,<br /></span>                         (Class&lt;K&gt;) jobConf.getMapOutputKeyClass()<span>,<br /></span>                         (Class&lt;V&gt;) jobConf.getMapOutputValueClass()<span>, </span>codec<span>, null, true</span>)<span>;<br /></span><span><br /></span>    RawKeyValueIterator iter  = <span>null;<br /></span>    CompressAwarePath compressAwarePath<span>;<br /></span>    Path tmpDir = <span>new </span>Path(reduceId.toString())<span>;<br /></span><span>    try </span>{<br />      iter = <b>Merger.merge(jobConf<span>, </span>rfs<span>,<br /></span>                         (Class&lt;K&gt;) jobConf.getMapOutputKeyClass()<span>,<br /></span>                         (Class&lt;V&gt;) jobConf.getMapOutputValueClass()<span>,<br /></span>                          codec<span>, </span>inputs.toArray(<span>new </span>Path[inputs.size()])<span>, <br /></span><span>                          true, </span>ioSortFactor<span>, </span>tmpDir<span>, <br /></span>                         (RawComparator&lt;K&gt;) jobConf.getOutputKeyComparator()<span>, <br /></span>                         reporter<span>, </span>spilledRecordsCounter<span>, null, <br /></span>                         mergedMapOutputsCounter<span>, null</span>)</b><span><b>;</b><br /></span><span><br /></span>      Merger.writeFile(iter<span>, </span>writer<span>, </span>reporter<span>, </span>jobConf)<span>;<br /></span>      writer.close()<span>;<br /></span>      compressAwarePath = <span>new </span>CompressAwarePath(outputPath<span>,   <br /></span>      writer.getRawLength()<span>, </span>writer.getCompressedLength())<span>;<br /></span>    } <span>catch </span>(IOException e) {<br />      localFS.delete(outputPath<span>, true</span>)<span>;<br /></span><span>      throw </span>e<span>;<br /></span>    }<br /><br />    closeOnDiskFile(compressAwarePath)<span>;<br /></span><span><br /></span>    LOG.info(reduceId +<br /><span>             " Finished merging " </span>+ inputs.size() + <br /><span>             " map output files on disk of total-size " </span>+ <br />             approxOutputSize + <span>"." </span>+ <br /><span>             " Local output file is " </span>+ outputPath + <span>" of size " </span>+<br />             localFS.getFileStatus(outputPath).getLen())<span>;<br /></span>  }<br />}</pre></pre></pre></pre></pre></div></div></foreignObject><text x="324" y="559" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 2980 839 L 3495 1401" fill="none" stroke="#d6b656" stroke-width="3" stroke-miterlimit="10" stroke-dasharray="9 9" pointer-events="none"/><rect x="790" y="459" width="620" height="1170" fill="#f5f5f5" stroke="#666666" pointer-events="none"/><g transform="translate(795.5,449.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="598" height="1176" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(51, 51, 51); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 1178px; max-width: 608px; width: 599px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>Shuffle.java</h1><pre>@Override<br /><span>public </span>RawKeyValueIterator run() <span>throws </span>IOException<span>, </span>InterruptedException {<br /><span>  // Scale the maximum events we fetch per RPC call to mitigate OOM issues<br /></span><span>  // on the ApplicationMaster when a thundering herd of reducers fetch events<br /></span><span>  // TODO: This should not be necessary after HADOOP-8942<br /></span><span>  int </span>eventsPerReducer = Math.max(MIN_EVENTS_TO_FETCH<span>,<br /></span>  MAX_RPC_OUTSTANDING_EVENTS / jobConf.getNumReduceTasks())<span>;<br /></span><span>  int </span>maxEventsToFetch = Math.min(MAX_EVENTS_TO_FETCH<span>, </span>eventsPerReducer)<span>;<br /></span><span><br /></span><span>  // Start the map-completion events fetcher thread<br /></span><span>  final </span>EventFetcher&lt;K<span>, </span>V&gt; eventFetcher =<br /><span>       new </span>EventFetcher&lt;K<span>, </span>V&gt;(reduceId<span>, </span>umbilical<span>, </span>scheduler<span>, this,<br /></span>       maxEventsToFetch)<span>;<br /></span>  eventFetcher.start()<span>;<br /></span><span><br /></span><span>  // Start the map-output fetcher threads<br /></span><span>  boolean </span>isLocal = localMapFiles != <span>null;<br /></span><span>  final int </span>numFetchers = isLocal ? <span>1 </span>:<br />      jobConf.getInt(MRJobConfig.SHUFFLE_PARALLEL_COPIES<span>, </span><span>5</span>)<span>;<br /></span>  Fetcher&lt;K<span>, </span>V&gt;[] fetchers = <span>new </span>Fetcher[numFetchers]<span>;<br /></span><span>  if </span>(isLocal) {<br />    fetchers[<span>0</span>] = <span>new </span>LocalFetcher&lt;K<span>, </span>V&gt;(jobConf<span>, </span>reduceId<span>, </span>scheduler<span>,<br /></span>                    merger<span>, </span>reporter<span>, </span>metrics<span>, this, </span>reduceTask.getShuffleSecret()<span>,<br /></span>                    localMapFiles)<span>;<br /></span><b>    fetchers[<span>0</span>].start()<span>;<br /></span></b>  } <span>else </span>{<br /><span>    for </span>(<span>int </span>i=<span>0</span><span>; </span>i &lt; numFetchers<span>; </span>++i) {<br />      fetchers[i] = <span>new </span>Fetcher&lt;K<span>, </span>V&gt;(jobConf<span>, </span>reduceId<span>, </span>scheduler<span>, </span>merger<span>,<br /></span>                                     reporter<span>, </span>metrics<span>, this, <br /></span>                                     reduceTask.getShuffleSecret())<span>;<br /></span><b>      fetchers[i].start()<span>;<br /></span></b>    }<br />  }<br /><br /><span>  // Wait for shuffle to complete successfully<br /></span><span>  while </span>(!scheduler.waitUntilDone(PROGRESS_FREQUENCY)) {<br />    reporter.progress()<span>;<br /></span><span><br /></span><span>    synchronized </span>(<span>this</span>) {<br /><span>      if </span>(throwable != <span>null</span>) {<br /><span>        throw new </span>ShuffleError(<span>"error in shuffle in " </span>+ throwingThreadName<span>,<br /></span>                               throwable)<span>;<br /></span>      }<br />    }<br />  }<br /><br /><span>  // Stop the event-fetcher thread<br /></span>  eventFetcher.shutDown()<span>;<br /></span><span><br /></span><span>  // Stop the map-output fetcher threads<br /></span><span>  for </span>(Fetcher&lt;K<span>, </span>V&gt; fetcher : fetchers) {<br />    fetcher.shutDown()<span>;<br /></span>  }<br /><br /><span>  // stop the scheduler<br /></span>  scheduler.close()<span>;<br /></span><span><br /></span>  copyPhase.complete()<span>; </span><span>// copy is already complete<br /></span>  taskStatus.setPhase(TaskStatus.Phase.SORT)<span>;<br /></span>  reduceTask.statusUpdate(umbilical)<span>;<br /></span><span><br /></span><span>  // Finish the on-going merges...<br /></span>  RawKeyValueIterator kvIter = <span>null;<br /></span><span>  try </span>{<br />    kvIter = merger.close()<span>;<br /></span>  } <span>catch </span>(Throwable e) {<br /><span>    throw new </span>ShuffleError(<span>"Error while doing final merge "</span><span>, </span>e)<span>;<br /></span>  }<br /><br /><span>  // Sanity check<br /></span><span>  synchronized </span>(<span>this</span>) {<br /><span>    if </span>(throwable != <span>null</span>) {<br /><span>      throw new </span>ShuffleError(<span>"error in shuffle in " </span>+ throwingThreadName<span>,<br /></span>                           throwable)<span>;<br /></span>    }<br />  }<br /><br /><span>  return </span>kvIter<span>;<br /></span>}</pre></div></div></foreignObject><text x="299" y="594" fill="#333333" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 789 1603 L 283.84 934.08" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 280.67 929.89 L 287.69 933.37 L 283.84 934.08 L 282.1 937.59 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 290 919 L 779 532.95" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 783.12 529.69 L 779.8 536.78 L 779 532.95 L 775.46 531.28 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><rect x="1500" y="459" width="430" height="370" fill="#e1d5e7" stroke="#9673a6" pointer-events="none"/><g transform="translate(1505.5,449.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="410" height="378" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 378px; max-width: 418px; width: 411px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>LocalFetcher.java</h1><pre><pre><span>public void </span>run() {<br /><span>  // Create a worklist of task attempts to work over.<br /></span>  Set&lt;TaskAttemptID&gt; maps = <span>new </span>HashSet&lt;TaskAttemptID&gt;()<span>;<br /></span><span>  for </span>(TaskAttemptID map : localMapFiles.keySet()) {<br />    maps.add(map)<span>;<br /></span>  }<br /><br /><span>  while </span>(maps.size() &gt; <span>0</span>) {<br /><span>    try </span>{<br /><span>      // If merge is on, block<br /></span><b>      merger.waitForResource()<span>;<br /></span></b>      metrics.threadBusy()<span>;<br /></span><span><br /></span><span>      // Copy as much as is possible.<br /></span>      doCopy(maps)<span>;<br /></span>      metrics.threadFree()<span>;<br /></span>    } <span>catch </span>(InterruptedException ie) {<br />    } <span>catch </span>(Throwable t) {<br />      exceptionReporter.reportException(t)<span>;<br /></span>    }<br />  }<br />}</pre></pre></div></div></foreignObject><text x="205" y="195" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="1500" y="889" width="490" height="440" fill="#e1d5e7" stroke="#9673a6" pointer-events="none"/><g transform="translate(1505.5,879.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="468" height="448" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; overflow: hidden; max-height: 448px; max-width: 478px; width: 469px; white-space: normal; overflow-wrap: normal;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><h1>Fetcher.java</h1><pre><pre><pre><span>public void </span>run() {<br /><span>  try </span>{<br /><span>    while </span>(!stopped &amp;&amp; !Thread.currentThread().isInterrupted()) {<br />      MapHost host = <span>null;<br /></span><span>      try </span>{<br /><span>        // If merge is on, block<br /></span><b>        merger.waitForResource()<span>;<br /></span></b><span><br /></span><span>        // Get a host to shuffle from<br /></span><b>        host = scheduler.getHost()<span>;<br /></span></b>        metrics.threadBusy()<span>;<br /></span><span><br /></span><span>        // Shuffle<br /></span>        copyFromHost(host)<span>;<br /></span>      } <span>finally </span>{<br /><span>        if </span>(host != <span>null</span>) {<br />          scheduler.freeHost(host)<span>;<br /></span>          metrics.threadFree()<span>;            <br /></span>        }<br />      }<br />    }<br />  } <span>catch </span>(InterruptedException ie) {<br /><span>    return;<br /></span>  } <span>catch </span>(Throwable t) {<br />    exceptionReporter.reportException(t)<span>;<br /></span>  }<br />}<br /></pre></pre></pre></div></div></foreignObject><text x="234" y="230" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 980 849 L 1492.64 520.44" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 1497.06 517.6 L 1493.05 524.33 L 1492.64 520.44 L 1489.28 518.43 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 990 939 L 1490.63 945.91" fill="none" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 1495.88 945.98 L 1488.83 949.39 L 1490.63 945.91 L 1488.93 942.39 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10" pointer-events="none"/><path d="M 1495 1310 L 995.13 942.77" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 990.9 939.66 L 998.61 940.99 L 995.13 942.77 L 994.47 946.63 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 1495 809 L 986.34 858.38" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/><path d="M 981.11 858.89 L 987.74 854.73 L 986.34 858.38 L 988.42 861.7 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="none"/></g></svg>